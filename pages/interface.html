<!DOCTYPE HTML>
<html>
<head>  
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />

	<link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

	<script src="http://code.jquery.com/jquery-1.8.3.js"></script>
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
	
	//Global Variables
	var iosocket;
	var pollOneH = 0;
	var poll1;
	var text;
	var potValue;
	var prevPotValue =0 ;
	var toggleVal = 0;

	var drink = "none";

	window.onload = function() 
	{
		initSocketIO();
	};

	function initSocketIO()
	{
		iosocket = io.connect();
		iosocket.on('onconnection', function (value) 
		{
			pollOneH = value.pollOneValue/2; // recieve start poll value from server
			initPoll();
			initButton();
			// recieve changed values by other client from server
			iosocket.on('updateData', function (receivedData) 
			{
				pollOneH = receivedData.pollOneValue/2; // recieve start poll value from server
			});

			iosocket.on('updateDrink', function (receivedData)
			{
				drink = receivedData.drink;
			});

		});
	}

	function initButton()
	{
		$( "#check" ).button();
	}

	function initPoll()
	{
		poll1 = 
		{
			x: 10,
			y: 540,
			w: 440,
			h: 0
		}
		text = 
		{
			x:poll1.w/2,
			y:100
		}

		if (typeof(potValue) == "number"){
			potValue = pollOneH*2;
			prevPotValue = potValue;
		}

		//start animation
		animation(poll1,text);
	}

	function animation(poll1,text)
	{
		var canvas = document.getElementById("myCanvas");
		var content = canvas.getContext("2d");

		// clear canvas
		content.clearRect(0, 0, 460, 540);
		content.fillStyle = 'black';
		content.textAlign = 'center';
		content.font = '20pt Calibri';
		
		// make the wobbely values stop 
		//3 is a magic number
		if(pollOneH*3 > prevPotValue+3 || pollOneH*3 < prevPotValue-3)
		{
			prevPotValue = potValue;
			potValue = pollOneH*3;
		}


		//Comment out Potmeter Value;
		content.fillText('Potmeter value: ' + potValue, text.x, text.y);
		content.fillText('Drink is: ' + drink, text.x, text.y-40);


		//Determines color
		content.fillStyle = 'black';
		if (drink=="Water")
		{
			content.fillStyle = "blue";
		}
		else if (drink == "Coke")
		{
			content.fillStyle = "brown";
		}

		// render graph 
		content.fillRect(poll1.x,(poll1.y-poll1.h),poll1.w,poll1.h);
	    content.fill();

		  // request new frame
		requestAnimFrame(function() 
		{
			if(poll1.h < pollOneH)
			{
				poll1.h += (pollOneH - poll1.h)*.15;
			}
			else if(poll1.h > pollOneH)
			{
				poll1.h -= (poll1.h - pollOneH)*.15;
			}
			text.y = (poll1.y - poll1.h) - 5;
			animation(poll1,text);
		});
	}
	

	// canvas request for all browsers
	window.requestAnimFrame = (function(callback) 
	{
		return window.requestAnimationFrame || 
		window.webkitRequestAnimationFrame || 
		window.mozRequestAnimationFrame || 
		window.oRequestAnimationFrame || 
		window.msRequestAnimationFrame ||
		function(callback) 
		{
		  window.setTimeout(callback, 1000 / 30); // 30 frames per second
		};
	})();





	$(document).ready(function() 
	{
		$('#check').click(function() 
		{
			toggleVal += 1;
			toggleVal %= 2;
			iosocket.emit('buttonval',toggleVal);
		});
	});
	</script>

</head>
<!-- Actual HTML -->
<body>
	<nav role="navigation" class="navbar">
	    <!-- Brand and toggle get grouped for better mobile display -->
	    <div class="navbar-header">
	        <button type="button" data-target="#navbarCollapse" data-toggle="collapse" class="navbar-toggle">
	            <span class="sr-only">Toggle navigation</span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	        </button>
	        <a href="main" class="navbar-brand"><img src="http://upload.wikimedia.org/wikipedia/en/9/9e/Thames_Water_logo.svg" style = "max-width:25px;"></a>
	    </div>
	    <!-- Collection of nav links and other content for toggling -->
	    <div id="navbarCollapse" class="collapse navbar-collapse">
	        <ul class="nav navbar-nav">
	            <li class="active"><a href="dashboard">Dashboard</a></li>
	            <li><a href="interface">Interface</a></li>
	            <li><a href="restaurant">Restaurant</a></li>
	        </ul>
	        <ul class="nav navbar-nav navbar-right">
	            <li><a href="main">Logout</a></li>
	        </ul>
	    </div>
	</nav>



	<div id="rData">
		<h1>Data from Arduino</h1>
		<div></div>
		<canvas id="myCanvas" width="460" height="540"></canvas>
		<div id="myCanvasWrapper">		</div>

	</div>

</body>
</html>